name: AI Smart Commit with Copilot + Smart Emoji

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  smart-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get git diff
        id: diff
        run: |
          git fetch origin main
          DIFF=$(git diff HEAD~1 HEAD)
          echo "diff<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Install Copilot CLI
        run: npm install -g @github/copilot-cli

      - name: Auth Copilot CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | copilot auth login --with-token

      - name: Generate commit type & emoji with Copilot
        id: ai-meta
        run: |
          PROMPT="You are an expert software developer. Analyze the following git diff and:
          1. Choose the correct Conventional Commit type (feat, fix, docs, test, chore, refactor, style, perf, build, ci).
          2. Pick ONE emoji that best matches the nature of the change.
          3. Write them together in the format: <emoji> <type>:
          Only output this single line.

          Git diff:
          $diff"

          META=$(echo "$PROMPT" | copilot suggest)
          echo "meta=$META" >> $GITHUB_ENV

      - name: Generate commit message with Copilot
        run: |
          PROMPT="Using the following git diff, write a short and clear commit message starting exactly with '${meta}' and summarizing the changes:
          $diff"
          COMMIT_MSG=$(echo "$PROMPT" | copilot suggest)
          echo "$COMMIT_MSG" > commit_message.txt

      - name: Commit changes with AI message
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit --allow-empty -m "$(cat commit_message.txt)" || echo "No changes to commit"
          git push
